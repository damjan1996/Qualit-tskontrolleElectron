<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' 'unsafe-eval';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdnjs.cloudflare.com;
        media-src 'self' blob: data: mediastream:;
        connect-src 'self' blob: data:;
        img-src 'self' blob: data: https:;
        style-src 'self' 'unsafe-inline';
    ">
    <title>RFID QR Wareneingang System</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Additional styles for camera test modal */
        .camera-test-info {
            margin-bottom: var(--spacing-lg);
        }

        .camera-test-info h4 {
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .camera-test-info h4:first-child {
            margin-top: 0;
        }

        .camera-device {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }

        .camera-device.error {
            border-color: var(--color-error);
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-error);
        }

        .permission-granted { color: var(--color-success); font-weight: 600; }
        .permission-denied { color: var(--color-error); font-weight: 600; }
        .permission-prompt { color: var(--color-warning); font-weight: 600; }
        .permission-unknown { color: var(--text-muted); font-weight: 600; }

        .btn-info {
            background: var(--color-info);
            color: white;
            border-color: var(--color-info);
        }

        .btn-info:hover:not(:disabled) {
            background: #0891b2;
        }

        /* Scanner improvements */
        .scanner-info .info-item .value.success { color: var(--color-success); }
        .scanner-info .info-item .value.error { color: var(--color-error); }
        .scanner-info .info-item .value.warning { color: var(--color-warning); }
    </style>
</head>
<body>
<!-- Header Section -->
<header class="app-header">
    <div class="header-content">
        <div class="header-left">
            <h1 class="app-title">
                <span class="icon">üè∑Ô∏è</span>
                RFID QR Wareneingang
            </h1>
            <div class="system-status" id="systemStatus">
                <span class="status-dot"></span>
                <span class="status-text">Initialisierung...</span>
            </div>
        </div>

        <div class="header-right">
            <div class="stats-group">
                <div class="stat-item">
                    <span class="stat-label">Aktive Benutzer:</span>
                    <span class="stat-value" id="activeUsersCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Heutige Scans:</span>
                    <span class="stat-value" id="totalScansCount">0</span>
                </div>
            </div>

            <div class="header-actions">
                <button class="action-btn" id="cameraTestBtn" title="Kamera testen">
                    <span class="icon">üì∑</span>
                </button>
                <button class="action-btn" id="minimizeBtn" title="Minimieren">
                    <span class="icon">üóï</span>
                </button>
                <button class="action-btn close-btn" id="closeBtn" title="Schlie√üen">
                    <span class="icon">‚úï</span>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="app-main">
    <!-- Left Panel - Active Users -->
    <section class="panel panel-users">
        <div class="panel-header">
            <h2 class="panel-title">
                <span class="icon">üë•</span>
                Aktive Benutzer
            </h2>
            <div class="panel-actions">
                <button class="btn btn-secondary" id="logoutAllBtn">
                    Alle abmelden
                </button>
            </div>
        </div>

        <div class="panel-content">
            <div class="users-list" id="usersList">
                <div class="empty-state" id="usersEmptyState">
                    <div class="empty-icon">üè∑Ô∏è</div>
                    <h3>Keine aktiven Benutzer</h3>
                    <p>Halten Sie Ihren RFID-Tag an den Reader</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Center Panel - QR Scanner -->
    <section class="panel panel-scanner">
        <div class="panel-header">
            <h2 class="panel-title">
                <span class="icon">üì∏</span>
                QR-Code Scanner
            </h2>
            <div class="scanner-controls">
                <button class="btn btn-primary" id="startScannerBtn">
                    Scanner starten
                </button>
                <button class="btn btn-secondary" id="stopScannerBtn" style="display: none;">
                    Scanner stoppen
                </button>
                <button class="btn btn-info btn-small" id="testQRBtn" title="Test QR generieren">
                    Test QR
                </button>
            </div>
        </div>

        <div class="panel-content">
            <div class="scanner-container">
                <div class="scanner-video-container" id="scannerVideoContainer">
                    <video id="scannerVideo" autoplay playsinline muted></video>
                    <div class="scanner-overlay">
                        <div class="scanner-crosshair"></div>
                        <div class="scanner-frame"></div>
                    </div>
                    <div class="scanner-status" id="scannerStatus">
                        <span class="icon">üì∑</span>
                        <span class="text">Klicken Sie "Scanner starten"</span>
                    </div>
                </div>

                <canvas id="scannerCanvas" style="display: none;"></canvas>
            </div>

            <div class="scanner-info">
                <div class="info-item">
                    <span class="label">Status:</span>
                    <span class="value" id="scannerStatusText">Bereit</span>
                </div>
                <div class="info-item">
                    <span class="label">Letzter Scan:</span>
                    <span class="value" id="lastScanTime">-</span>
                </div>
                <div class="info-item">
                    <span class="label">Kamera:</span>
                    <span class="value" id="cameraInfo">Nicht erkannt</span>
                </div>
                <div class="info-item">
                    <span class="label">Aufl√∂sung:</span>
                    <span class="value" id="resolutionInfo">-</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Right Panel - Recent Scans -->
    <section class="panel panel-scans">
        <div class="panel-header">
            <h2 class="panel-title">
                <span class="icon">üìã</span>
                Letzte Scans
            </h2>
            <div class="panel-actions">
                <button class="btn btn-secondary" id="clearScansBtn">
                    Leeren
                </button>
            </div>
        </div>

        <div class="panel-content">
            <div class="scans-list" id="scansList">
                <div class="empty-state" id="scansEmptyState">
                    <div class="empty-icon">üìã</div>
                    <h3>Keine Scans</h3>
                    <p>QR-Codes erscheinen hier nach dem Scannen</p>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Footer -->
<footer class="app-footer">
    <div class="footer-content">
        <div class="footer-left">
            <span class="footer-text" id="instructionsText">
                üí° RFID scannen = Anmelden/Abmelden | QR-Code scannen = Wareneingang erfassen
            </span>
        </div>

        <div class="footer-right">
            <span class="footer-text" id="versionText">v1.0.0</span>
            <span class="footer-separator">|</span>
            <span class="footer-text" id="timestampText"></span>
        </div>
    </div>
</footer>

<!-- Modals -->

<!-- QR Assignment Modal (for manual assignment) -->
<div class="modal" id="qrAssignmentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">QR-Code zuordnen</h3>
            <button class="modal-close" id="qrAssignmentModalClose">‚úï</button>
        </div>

        <div class="modal-body">
            <div class="qr-preview">
                <h4>QR-Code Inhalt:</h4>
                <div class="qr-content" id="qrAssignmentContent"></div>
            </div>

            <div class="user-selection">
                <h4>Benutzer ausw√§hlen:</h4>
                <div class="user-buttons" id="qrAssignmentUsers"></div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" id="qrAssignmentCancel">Abbrechen</button>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal" id="errorModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <span class="icon">‚ö†Ô∏è</span>
                Fehler
            </h3>
            <button class="modal-close" id="errorModalClose">‚úï</button>
        </div>

        <div class="modal-body">
            <div class="error-message" id="errorMessage"></div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-primary" id="errorModalOk">OK</button>
        </div>
    </div>
</div>

<!-- Camera Test Modal -->
<div class="modal" id="cameraTestModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <span class="icon">üì∑</span>
                Kamera Test
            </h3>
            <button class="modal-close" id="cameraTestModalClose">‚úï</button>
        </div>

        <div class="modal-body">
            <div class="camera-test-info">
                <h4>Verf√ºgbare Kameras:</h4>
                <div id="cameraList"></div>

                <h4>Kamera Berechtigungen:</h4>
                <div id="permissionStatus"></div>

                <button class="btn btn-primary" id="requestPermissionBtn">Berechtigung anfordern</button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" id="cameraTestModalCancel">Schlie√üen</button>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div class="notifications" id="notifications"></div>

<!-- Scripts -->
<script src="app.js"></script>
</body>
</html>